<html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1" /><title>Implements The Quick Return Animation</title><meta name="twitter:card" content="summary" /><meta name="twitter:site" content="@drak11t" /><meta name="twitter:title" content="Implements The Quick Return Animation" /><meta name="twitter:description" content="今天把 贝壳单词 中英语角的 quick return 效果剥离出来写了个 Demo，讲解使用 RecyclerView 写快速返回菜单，效果如下（分别是贝壳单词和 Demo 的截图）："><meta name="description" content="今天把 贝壳单词 中英语角的 quick return 效果剥离出来写了个 Demo，讲解使用 RecyclerView 写快速返回菜单，效果如下（分别是贝壳单词和 Demo 的截图）："><link rel="icon" href="/assets/favicon.png"><link rel="apple-touch-icon" href="/assets/gravatar.png"><link rel="stylesheet" href="//code.cdn.mozilla.net/fonts/fira.css"><link rel="stylesheet" href="/assets/core.css"><link rel="canonical" href="/implements-the-quick-return-animation"><link rel="alternate" type="application/atom+xml" title="Black history of Drakeet" href="/feed.xml" /></head><body><aside class="logo"> <a href="/"> <img class="gravatar" width="80px" height="80px" src="/assets/gravatar.png"> </a> <span class="logo-prompt">返回</span></aside><main> <noscript><style> article .footnotes { display: block; }</style></noscript><article><div class="center"><h1>Implements The Quick Return Animation</h1><time>2 14, 2015</time></div><div class="divider"></div><p>今天把 <a title="贝壳单词下载" href="http://fir.im/seashell" target="_blank">贝壳单词</a> 中英语角的 quick return 效果剥离出来写了个 Demo，讲解使用 RecyclerView 写快速返回菜单，效果如下（分别是贝壳单词和 Demo 的截图）：</p><p><img class="alignnone wp-image-760" src="/assets/img/2015-04-12-anim-1.gif" alt="贝壳单词英语角" width="171" height="306" /> <img class="alignnone wp-image-761" src="/assets/img/2015-04-12-anim-2.png" alt="device-2015-02-14-143056" width="171" height="304" /></p><p>通过这篇文章你将了解到的知识有：</p><ul><li>RecyclerView 和其适配器的基本使用</li><li>RV 适配多种 Item View 类型写法</li><li>mRecyclerView.setOnScrollListener()</li><li>nineoldandroids 这个强大 View 操作库的使用</li></ul><!--more--><p>首先要在 layout 布局中新建 RecyclerView (以下称 RV) 布局，需要两个层次，一层 RV 置于底层，一层头部的 quick return View，没难度，不细说了，布局如下：</p><div class="highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;FrameLayout</span>
    <span class="na">android:layout_width=</span><span class="s">"match_parent"</span>
    <span class="na">android:layout_height=</span><span class="s">"match_parent"</span>
    <span class="na">xmlns:android=</span><span class="s">"http://schemas.android.com/apk/res/android"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;android.support.v7.widget.RecyclerView</span>
        <span class="na">android:id=</span><span class="s">"@+id/list"</span>
        <span class="na">android:layout_width=</span><span class="s">"match_parent"</span>
        <span class="na">android:layout_height=</span><span class="s">"match_parent"</span><span class="nt">/&gt;</span>

    <span class="nt">&lt;include</span> <span class="na">layout=</span><span class="s">"@layout/view_header"</span><span class="nt">/&gt;</span>

<span class="nt">&lt;/FrameLayout&gt;</span>
</code></pre></div><p>与这个布局相关的实例化关联代码我也都不再说明了，这些简单琐碎的细节如果不懂可以直接看源码，源码在文章末尾会给出。</p><h4>关键点1：给第 0 位 item 设置空白占位 View</h4><p>说明：为什么要使用这样的方式，因为像 ListView、RecyclerView 这类控件，如果动态改变它整体位置会很卡很糟糕，因此只能将第 0 位 item 设置为空白占位 View，其之上将覆盖那个能够快速返回复出的 Header View。所以这里需要在一开始把这个空白 view 量出来，并且设定进去：</p><div class="highlighter-rouge"><pre class="highlight"><code><span class="n">LinearLayoutManager</span> <span class="n">linearLayoutManager</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinearLayoutManager</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
<span class="n">linearLayoutManager</span><span class="o">.</span><span class="na">setOrientation</span><span class="o">(</span><span class="n">LinearLayoutManager</span><span class="o">.</span><span class="na">VERTICAL</span><span class="o">);</span>
<span class="n">mRecyclerView</span><span class="o">.</span><span class="na">setLayoutManager</span><span class="o">(</span><span class="n">linearLayoutManager</span><span class="o">);</span>
<span class="n">mDataList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>

<span class="n">View</span> <span class="n">paddingView</span> <span class="o">=</span> <span class="k">new</span> <span class="n">View</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
<span class="n">AbsListView</span><span class="o">.</span><span class="na">LayoutParams</span> <span class="n">params</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AbsListView</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">(</span>
        <span class="n">AbsListView</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">.</span><span class="na">MATCH_PARENT</span><span class="o">,</span> <span class="n">mFlexibleSpaceOffset</span>
<span class="o">);</span>
<span class="n">paddingView</span><span class="o">.</span><span class="na">setLayoutParams</span><span class="o">(</span><span class="n">params</span><span class="o">);</span>
<span class="n">paddingView</span><span class="o">.</span><span class="na">setBackgroundColor</span><span class="o">(</span><span class="n">Color</span><span class="o">.</span><span class="na">WHITE</span><span class="o">);</span>
<span class="n">mListAdapter</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MyListAdapter</span><span class="o">(</span><span class="n">mDataList</span><span class="o">);</span>
<span class="n">mListAdapter</span><span class="o">.</span><span class="na">addHeaderView</span><span class="o">(</span><span class="n">paddingView</span><span class="o">);</span>
<span class="n">mRecyclerView</span><span class="o">.</span><span class="na">setAdapter</span><span class="o">(</span><span class="n">mListAdapter</span><span class="o">);</span>
</code></pre></div><p>以上是给 RV 设置布局管理器，和设置 paddingView, 即我在上面说明的空白占位 View。</p><h4>关键点2：给 RV 设置滚动监听器</h4><p>说明 RV 自带有不错的滚动监听器设置方法，值得一说的是 onScrolled 方法的 dx、dy 参数，差不多可以说是单位时间内滚动的距离，所以我们如果要获取一次滚动操作的总距离，就要把这一次的全部 dy 叠加起来。官方文档对于这两个参数的解释是：</p><table class="jd-tagtable"><tbody><tr><th>dx</th><td>The amount of horizontal scroll.</td></tr><tr><th>dy</th><td>The amount of vertical scroll.</td></tr></tbody></table><p>我的理解就是单位时间内滚动的距离（可正可负），其命名 d，也和数学的微分表达一样。</p><p>在明白了这两个参数之后，就很好办了，代码如下：</p><div class="highlighter-rouge"><pre class="highlight"><code><span class="n">mRecyclerView</span><span class="o">.</span><span class="na">setOnScrollListener</span><span class="o">(</span>
        <span class="k">new</span> <span class="n">RecyclerView</span><span class="o">.</span><span class="na">OnScrollListener</span><span class="o">()</span> <span class="o">{</span>
            <span class="kt">boolean</span> <span class="n">isIdle</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">scrollY</span><span class="o">;</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="n">onScrollStateChanged</span><span class="o">(</span><span class="n">RecyclerView</span> <span class="n">recyclerView</span><span class="o">,</span> <span class="kt">int</span> <span class="n">newState</span><span class="o">)</span> <span class="o">{</span>
                <span class="kd">super</span><span class="o">.</span><span class="na">onScrollStateChanged</span><span class="o">(</span><span class="n">recyclerView</span><span class="o">,</span> <span class="n">newState</span><span class="o">);</span>
                <span class="n">isIdle</span> <span class="o">=</span> <span class="n">newState</span> <span class="o">==</span> <span class="n">RecyclerView</span><span class="o">.</span><span class="na">SCROLL_STATE_IDLE</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">isIdle</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">scrollY</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="n">onScrolled</span><span class="o">(</span><span class="n">RecyclerView</span> <span class="n">recyclerView</span><span class="o">,</span> <span class="kt">int</span> <span class="n">dx</span><span class="o">,</span> <span class="kt">int</span> <span class="n">dy</span><span class="o">)</span> <span class="o">{</span>
                <span class="kd">super</span><span class="o">.</span><span class="na">onScrolled</span><span class="o">(</span><span class="n">recyclerView</span><span class="o">,</span> <span class="n">dx</span><span class="o">,</span> <span class="n">dy</span><span class="o">);</span>
                <span class="n">scrollY</span> <span class="o">+=</span> <span class="n">dy</span><span class="o">;</span>
                <span class="c1">// show or hide header view</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">scrollY</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">hideHeader</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="n">showHeader</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
<span class="o">);</span>
</code></pre></div><p>顶部 View 收起和复出的代码，其实很简单，看了就知道了，这个 ViewPropertyAnimator 工具类就是来自 nineoldandroids.</p><div class="highlighter-rouge"><pre class="highlight"><code><span class="kd">private</span> <span class="kt">void</span> <span class="nf">showHeader</span><span class="p">(</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">mHeaderIsShown</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ViewPropertyAnimator</span><span class="o">.</span><span class="na">animate</span><span class="o">(</span><span class="n">mHeader</span><span class="o">).</span><span class="na">cancel</span><span class="o">();</span>
        <span class="n">ViewPropertyAnimator</span><span class="o">.</span><span class="na">animate</span><span class="o">(</span><span class="n">mHeader</span><span class="o">).</span><span class="na">translationY</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">setDuration</span><span class="o">(</span><span class="mi">200</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="n">mHeaderIsShown</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">void</span> <span class="nf">hideHeader</span><span class="p">(</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mHeaderIsShown</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ViewPropertyAnimator</span><span class="o">.</span><span class="na">animate</span><span class="o">(</span><span class="n">mHeader</span><span class="o">).</span><span class="na">cancel</span><span class="o">();</span>
        <span class="n">ViewPropertyAnimator</span><span class="o">.</span><span class="na">animate</span><span class="o">(</span><span class="n">mHeader</span><span class="o">).</span><span class="na">translationY</span><span class="o">(-</span><span class="n">mFlexibleSpaceOffset</span><span class="o">).</span><span class="na">setDuration</span><span class="o">(</span><span class="mi">200</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="n">mHeaderIsShown</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><h4>关键点3：Adapter 多类型</h4><p>说明：由于第 0 个位置我们已经加入了空白 View 占位了，所以实际上，这个 RV 中是有两种 View 的，一种就是那个空白 View，它将被 quick return 覆盖，一种是从第 1 个位置开始的正常 item view。</p><p>所以要重写 getItemViewType 方法：</p><div class="highlighter-rouge"><pre class="highlight"><code><span class="k">return</span> <span class="n">position</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">TYPE_HEADER</span> <span class="o">:</span> <span class="n">TYPE_CHILD</span><span class="o">;</span>
</code></pre></div><p>然后父类的 onCreateViewHolder 会调用到上面这个方法，判断 type 然后返回相应的 View：</p><div class="highlighter-rouge"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="n">MyListAdapter</span><span class="o">.</span><span class="na">ViewHolder</span> <span class="nf">onCreateViewHolder</span><span class="p">(</span><span class="n">ViewGroup</span> <span class="n">parent</span><span class="o">,</span> <span class="kt">int</span> <span class="n">viewType</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mView</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">viewType</span> <span class="o">==</span> <span class="n">TYPE_HEADER</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">ViewHolder</span><span class="o">(</span><span class="n">mView</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">View</span> <span class="n">v</span> <span class="o">=</span> <span class="n">LayoutInflater</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">parent</span><span class="o">.</span><span class="na">getContext</span><span class="o">()).</span><span class="na">inflate</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">item_list</span><span class="o">,</span> <span class="n">parent</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
        <span class="n">ViewHolder</span> <span class="n">holder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ViewHolder</span><span class="o">(</span><span class="n">v</span><span class="o">);</span>
        <span class="n">holder</span><span class="o">.</span><span class="na">content</span> <span class="o">=</span> <span class="o">(</span><span class="n">TextView</span><span class="o">)</span> <span class="n">v</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">content</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">holder</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onBindViewHolder</span><span class="p">(</span><span class="n">MyListAdapter</span><span class="o">.</span><span class="na">ViewHolder</span> <span class="n">holder</span><span class="o">,</span> <span class="kt">int</span> <span class="n">position</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">holder</span><span class="o">.</span><span class="na">getItemViewType</span><span class="o">()</span> <span class="o">==</span> <span class="n">TYPE_HEADER</span><span class="o">)</span> <span class="k">return</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mView</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">position</span> <span class="o">=</span> <span class="n">position</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">final</span> <span class="n">String</span> <span class="n">string</span> <span class="o">=</span> <span class="n">mList</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">position</span><span class="o">);</span>
    <span class="n">holder</span><span class="o">.</span><span class="na">content</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">string</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div><p>值得注意的是，我预留了一个 public void addHeaderView(View view) 的方法，用来给外部调用设置这个空白 View，也就是我们一开始使用的那个方法，并且在这个 Adapter 中如果这个 HeaderView 不为空，就是有空白 View，就要在 getItemCount 方法中返回的时候，+1：</p><div class="highlighter-rouge"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">int</span> <span class="nf">getItemCount</span><span class="p">(</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">mView</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">mList</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">mList</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div><p>至此，基本所有的关键的都讲完了，如果还有细节问题，可以再看看我的源代码：</p><p><a href="https://github.com/drakeet/RecyclerQuickReturnDemo" target="_blank">https://github.com/drakeet/RecyclerQuickReturnDemo</a></p><p>（注意：我使用的是最新的 Android Studio 最新的 Gradle，如果你编译或载入不了，也不用太在意，直接用文本编辑器什么的打开 java 源代码文件阅读就好，不一定非要用 IDE）</p><p>Demo apk 下载：</p><p><a href="https://github.com/drakeet/RecyclerQuickReturnDemo/raw/master/app-demo.apk" target="_blank">https://github.com/drakeet/RecyclerQuickReturnDemo/raw/master/app-demo.apk</a></p></article></main></body></html>
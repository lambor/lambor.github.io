<html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1" /><title>使用 Python 创建 Telegram 机器人</title><meta name="twitter:card" content="summary" /><meta name="twitter:site" content="@drak11t" /><meta name="twitter:title" content="使用 Python 创建 Telegram 机器人" /><meta name="twitter:description" content="要说聊天体验，telegram 比微信好很多，微信消息一多就卡，而且没法直接引用消息进行回复导致经常找不到上下文。telegram 则始终异常流畅，记录阅读位置，消息多的时候也不会觉得跟不上聊天节奏或卡 … 当然了，这一段都不是今天要写的这篇文章的重点，这篇文章主要还是要介绍一下如何开发 telegram 机器人，telegram 在去年中旬的时候开放了机器人的 API，可以设置 hook，..."><meta name="description" content="要说聊天体验，telegram 比微信好很多，微信消息一多就卡，而且没法直接引用消息进行回复导致经常找不到上下文。telegram 则始终异常流畅，记录阅读位置，消息多的时候也不会觉得跟不上聊天节奏或卡 … 当然了，这一段都不是今天要写的这篇文章的重点，这篇文章主要还是要介绍一下如何开发 telegram 机器人..."><link rel="icon" href="/assets/favicon.png"><link rel="apple-touch-icon" href="/assets/gravatar.png"><link rel="stylesheet" href="//code.cdn.mozilla.net/fonts/fira.css"><link rel="stylesheet" href="/assets/core.css"><link rel="canonical" href="/create-telegram-bot-with-python"><link rel="alternate" type="application/atom+xml" title="Black history of Drakeet" href="/feed.xml" /></head><body><aside class="logo"> <a href="/"> <img class="gravatar" width="80px" height="80px" src="/assets/gravatar.png"> </a> <span class="logo-prompt">返回</span></aside><main> <noscript><style> article .footnotes { display: block; }</style></noscript><article><div class="center"><h1>使用 Python 创建 Telegram 机器人</h1><time>2 21, 2016</time></div><div class="divider"></div><p>要说聊天体验，telegram 比微信好很多，微信消息一多就卡，而且没法直接引用消息进行回复导致经常找不到上下文。telegram 则始终异常流畅，记录阅读位置，消息多的时候也不会觉得跟不上聊天节奏或卡 … 当然了，这一段都不是今天要写的这篇文章的重点，这篇文章主要还是要介绍一下如何开发 telegram 机器人，telegram 在去年中旬的时候开放了机器人的 API，可以设置 hook，使得所有消息都能被转发到你的服务上，然后作出自动化回复。</p><p>机器人可以被邀请入群做很多辅助工作，比如输入 <code class="highlighter-rouge">/google xxx</code> 就可以得到谷歌查询的结果等等，甚至还有人开发了 <code class="highlighter-rouge">/fff</code> 命令，用来烧死异性恋😂什么的，只要发送一条 <code class="highlighter-rouge">/fff install someone</code> 的消息到机器人所在的群聊当中即可。总之，利用 bot API 几乎无所不能，也十分有意思。</p><p>俺从几天前开始玩耍 telegram bot API，开发了一个属于自己的机器人，<a href="http://telegram.me/XiaoaiBot" target="_blank">@XiaoaiBot</a>，可以回声、计算两个日期的间隔时间、以及帮用户在群里找出最近一个 @ 消息，应该说还是非常好玩的。</p><h4>@BotFather</h4><p>一开始得在 telegram 中添加一个“机器人之父”的账号，便是 <a href="http://telegram.me/BotFather" target="_blank">@BotFather</a> 这个账号，然后给它发送 <code class="highlighter-rouge">/newbot</code> 命令，逐步建立起一个机器人，包括头像、介绍，以及它可以支持的命令，另外，最重要的就是能够得到这个机器人的 token，通过这个 token 可以调用官方机器人 API 收发消息。</p><h4>token 的使用</h4><p>telegram bot API 的官方文档是：<a href="https://core.telegram.org/bots/api" target="_blank">https://core.telegram.org/bots/api</a>，在这里可以看到，所有的接口都是基于 <a href="https://api.telegram.org/bot+你的token" target="_blank">https://api.telegram.org/bot+你的token</a> 这个 base url，比如你的 token 是 <code class="highlighter-rouge">123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11</code>，那么你调用任何 API 都得基于 https://api.telegram.org/bot123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11/，后面再加上具体 API 名。</p><h4>设置消息 hook</h4><p>telegram 支持两种获得消息的方式，一种是开发中利用 <code class="highlighter-rouge">getUpdates</code> 接口主动去查询是否有新消息，另外一种就是推荐的 <code class="highlighter-rouge">setWebhook</code>，设置一个 <code class="highlighter-rouge">https</code> 的服务地址，完事之后，所有机器人收到的消息都会同时发往这个地址，并携带上 json 数据，使用 python 的时候，可以通过 <code class="highlighter-rouge">flask</code> 这个框架的 <code class="highlighter-rouge">request.get_json(force=True)</code> 来获取到 json 数据。</p><p>设置 hook 的示例 API url 如下：</p><p>https://api.telegram.org/bot你的token/setWebhook?url=https://xxx.com</p><h4>使用 python-telegram-bot 库进行开发</h4><p>GitHub 上有一个别人已经封装好了的 <code class="highlighter-rouge">python-telegram-bot</code> 库，可以帮助开发者更近轻松快速地使用官方 API：<a href="https://github.com/python-telegram-bot/python-telegram-bot" target="_blank">https://github.com/python-telegram-bot/python-telegram-bot</a></p><p>将它装载下来后，你可以通过以下代码进行初始化：</p><div class="highlighter-rouge"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">telegram</span>
<span class="n">bot</span> <span class="o">=</span> <span class="n">telegram</span><span class="o">.</span><span class="n">Bot</span><span class="p">(</span><span class="n">token</span><span class="o">=</span><span class="s">'你的token'</span><span class="p">)</span>
</code></pre></div><p>然后就可以通过这个 bot 对象发送各种消息了，更多使用内容可以参看其开源代码的 readme，或者官方文档：<a href="http://python-telegram-bot.readthedocs.org/en/latest/py-modindex.html" target="_blank">http://python-telegram-bot.readthedocs.org/en/latest/py-modindex.html</a></p><h4>我的 @XiaoaiBot 项目</h4><p>有了各种准备内容后，我们还需要 <code class="highlighter-rouge">flask</code> 框架来提供 <code class="highlighter-rouge">http</code> 服务响应，<code class="highlighter-rouge">flask</code> 我就不多说了，应该学过 python 的都会懂得使用这个框架。主要说一下我开发小爱 bot 的一些思路和代码。</p><p>我写了一个 <code class="highlighter-rouge">launcher</code> 和 <code class="highlighter-rouge">handle_message</code> 方法用来分发命令到具体到执行代码：</p><div class="highlighter-rouge"><pre class="highlight"><code><span class="nd">@app.route</span><span class="p">(</span><span class="s">'/&lt;token&gt;'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">launcher</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">"POST"</span><span class="p">:</span>
        <span class="n">update</span> <span class="o">=</span> <span class="n">telegram</span><span class="o">.</span><span class="n">Update</span><span class="o">.</span><span class="n">de_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
        <span class="n">handle_message</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">'ok'</span>

<span class="k">def</span> <span class="nf">handle_message</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">text</span>
    <span class="k">if</span> <span class="s">'/echo'</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
        <span class="n">echo</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="k">elif</span> <span class="s">'/milestone'</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
        <span class="n">milestone</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="k">elif</span> <span class="s">'/help'</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
        <span class="n">help</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="k">elif</span> <span class="s">'/getmylastat'</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
        <span class="n">get_my_last_at</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="k">elif</span> <span class="s">'/pic'</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
        <span class="n">pic</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="k">elif</span> <span class="s">'/delpic'</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
        <span class="n">delpic</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="s">'/'</span> <span class="ow">in</span> <span class="n">text</span> <span class="ow">and</span> <span class="s">'@'</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
        <span class="n">save_at_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</code></pre></div><p>这个方法应该一目了然，不多说，主要作为分发命令消息到入口。</p><p>另外我还写了一个用来分离命令和附着文本的方法：</p><div class="highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">parse_cmd_text</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="c"># Telegram understands UTF-8, so encode text for unicode compatibility</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">)</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="s">'/'</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">' '</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">text</span><span class="p">[:</span><span class="n">index</span><span class="p">]</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cmd</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">and</span> <span class="s">'@'</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">bot_name</span><span class="p">,</span> <span class="s">''</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
</code></pre></div><p>其中需要注意到是，有可能用户发送到命令是：<code class="highlighter-rouge">/xxx@XiaoaiBot 123</code> 这样，就得把@XiaoaiBot 这个无用的内容去掉，我使用 <code class="highlighter-rouge">replace</code> 方法将机器人的名字替换为空字符，这样就相当于删掉这个内容了。另外，也可以使用 python 的 re 正则表达式来匹配得到同样的结果，不多说。</p><p>整个开发过程还是非常愉快和轻松的，我使用的是 leancloud 美国节点进行部署，其中需要注意的是，其美国节点不支持命令行部署，只能 git 部署，于是我不得不开源我的 token，开源代码是：</p><p><a href="https://github.com/drakeet/DrakeetLoveBot" target="_blank">https://github.com/drakeet/DrakeetLoveBot</a></p><p>希望大家如果 fork 我的代码使用，不要使用我的 token，因为会造成我的服务有可能出现混乱，我也会伤心以后不敢再开源了之类的，而且，申请一个 token 是非常容易的，完全没必要使用我的，祝玩得开心，也欢迎来玩耍俺的机器人 <a href="http://telegram.me/XiaoaiBot" target="_blank">@XiaoaiBot</a>，提供的功能如下：</p><ul><li><code class="highlighter-rouge">/echo</code> - Repeat the same message back</li><li><code class="highlighter-rouge">/milestone</code> - Get drakeet’s milestone</li><li><code class="highlighter-rouge">/getmylastat</code> - Get my last AT message</li><li><code class="highlighter-rouge">/pic</code></li><li><code class="highlighter-rouge">/delpic</code></li><li><code class="highlighter-rouge">/songci</code> - 获取一篇宋词</li></ul></article></main></body></html>
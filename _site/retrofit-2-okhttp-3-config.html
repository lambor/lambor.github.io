<html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1" /><title>Retrofit 2.0 + OkHttp 3.0 配置</title><meta name="twitter:card" content="summary" /><meta name="twitter:site" content="@drak11t" /><meta name="twitter:title" content="Retrofit 2.0 + OkHttp 3.0 配置" /><meta name="twitter:description" content="Retrofit 和 OkHttp 都是伟大的 Square 公司开源的伟大项目。前段时间也是从 Retrofit 1.9 升级到 2.0 beta 4 版本，从 OkHttp 2.+ 版本升级到  3.0.1 版本。这两者在各自的这两个大版本升级中，都改变了不少，使得原本的代码都需要进行一些修改才能使用，我也是稍微摸索了几下，如今大致摸清，把一些基础配置，比如设置 Json 转换器、RxJ..."><meta name="description" content="Retrofit 和 OkHttp 都是伟大的 Square 公司开源的伟大项目。前段时间也是从 Retrofit 1.9 升级到 2.0 beta 4 版本，从 OkHttp 2.+ 版本升级到  3.0.1 版本。这两者在各自的这两个大版本升级中，都改变了不少，使得原本的代码都需要进行一些修改才能使用，我也是..."><link rel="icon" href="/assets/favicon.png"><link rel="apple-touch-icon" href="/assets/gravatar.png"><link rel="stylesheet" href="//code.cdn.mozilla.net/fonts/fira.css"><link rel="stylesheet" href="/assets/core.css"><link rel="canonical" href="/retrofit-2-okhttp-3-config"><link rel="alternate" type="application/atom+xml" title="Black history of Drakeet" href="/feed.xml" /></head><body><aside class="logo"> <a href="/"> <img class="gravatar" width="80px" height="80px" src="/assets/gravatar.png"> </a> <span class="logo-prompt">返回</span></aside><main> <noscript><style> article .footnotes { display: block; }</style></noscript><article><div class="center"><h1>Retrofit 2.0 + OkHttp 3.0 配置</h1><time>3 2, 2016</time></div><div class="divider"></div><p>Retrofit 和 OkHttp 都是伟大的 Square 公司开源的伟大项目。前段时间也是从 Retrofit 1.9 升级到 2.0 beta 4 版本，从 OkHttp 2.+ 版本升级到  3.0.1 版本。这两者在各自的这两个大版本升级中，都改变了不少，使得原本的代码都需要进行一些修改才能使用，我也是稍微摸索了几下，如今大致摸清，把一些基础配置，比如设置 Json 转换器、RxJava 适配器、设置 Debug Log 模式、设置超时、错误重连，以及配置 Access token Interceptor 等等一些内容，分享一下。</p><h4>引入依赖：</h4><div class="highlighter-rouge"><pre class="highlight"><code><span class="n">compile</span> <span class="s1">'com.squareup.retrofit2:retrofit:2.0.0-beta4'</span>
<span class="n">compile</span> <span class="s1">'com.squareup.retrofit2:converter-gson:2.0.0-beta4'</span>
<span class="n">compile</span> <span class="s1">'com.squareup.retrofit2:adapter-rxjava:2.0.0-beta4'</span>
<span class="n">compile</span> <span class="s1">'com.squareup.okhttp3:okhttp:3.0.1'</span>
<span class="n">compile</span> <span class="s1">'com.squareup.okhttp3:logging-interceptor:3.0.1'</span>
</code></pre></div><h4>OkHttp：</h4><p>先说 OkHttp 3.0 的配置，3.0 使用层面上的主要改变是，由原本的 okHttp 对象直接各种 set 进行配置改为 Builder 配置模式，所以原本对应的方法应该到 OkHttpClient.Builder 类对象下寻找。我的一些常用配置如下：</p><div class="highlighter-rouge"><pre class="highlight"><code><span class="n">HttpLoggingInterceptor</span> <span class="n">interceptor</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HttpLoggingInterceptor</span><span class="o">();</span>
<span class="n">interceptor</span><span class="o">.</span><span class="na">setLevel</span><span class="o">(</span><span class="n">HttpLoggingInterceptor</span><span class="o">.</span><span class="na">Level</span><span class="o">.</span><span class="na">BODY</span><span class="o">);</span>
<span class="n">OkHttpClient</span> <span class="n">client</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OkHttpClient</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">addInterceptor</span><span class="o">(</span><span class="n">interceptor</span><span class="o">)</span>
        <span class="o">.</span><span class="na">retryOnConnectionFailure</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
        <span class="o">.</span><span class="na">connectTimeout</span><span class="o">(</span><span class="mi">15</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">)</span>
        <span class="o">.</span><span class="na">addNetworkInterceptor</span><span class="o">(</span><span class="n">mTokenInterceptor</span><span class="o">)</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</code></pre></div><p>解释：</p><ul><li>HttpLoggingInterceptor 是一个拦截器，用于输出网络请求和结果的 Log，可以配置 level 为 BASIC / HEADERS / BODY，都很好理解，对应的是原来 retrofit 的 set log level 方法，现在 retrofit 已经没有这个方法了，所以只能到 OkHttp 这边来配置，并且 BODY 对应原来到 FULL.</li><li>retryOnConnectionFailure 方法为设置出现错误进行重新连接。</li><li>connectTimeout 设置超时时间</li><li>addNetworkInterceptor 让所有网络请求都附上你的拦截器，我这里设置了一个 token 拦截器，就是在所有网络请求的 header 加上 token 参数，下面会稍微讲一下这个内容。</li></ul><p>让所有网络请求都附上你的 token：</p><div class="highlighter-rouge"><pre class="highlight"><code><span class="n">Interceptor</span> <span class="n">mTokenInterceptor</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Interceptor</span><span class="o">()</span> <span class="o">{</span>
    <span class="nd">@Override</span> <span class="kd">public</span> <span class="n">Response</span> <span class="n">intercept</span><span class="o">(</span><span class="n">Chain</span> <span class="n">chain</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">Request</span> <span class="n">originalRequest</span> <span class="o">=</span> <span class="n">chain</span><span class="o">.</span><span class="na">request</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">Your</span><span class="o">.</span><span class="na">sToken</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">alreadyHasAuthorizationHeader</span><span class="o">(</span><span class="n">originalRequest</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">chain</span><span class="o">.</span><span class="na">proceed</span><span class="o">(</span><span class="n">originalRequest</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">Request</span> <span class="n">authorised</span> <span class="o">=</span> <span class="n">originalRequest</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">()</span>
            <span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="s">"Authorization"</span><span class="o">,</span> <span class="n">Your</span><span class="o">.</span><span class="na">sToken</span><span class="o">)</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">chain</span><span class="o">.</span><span class="na">proceed</span><span class="o">(</span><span class="n">authorised</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">};</span>
</code></pre></div><p>解释：</p><ul><li>那个 if 判断意思是，如果你的 token 是空的，就是还没有请求到 token，比如对于登陆请求，是没有 token 的，只有等到登陆之后才有 token，这时候就不进行附着上 token。另外，如果你的请求中已经带有验证 header 了，比如你手动设置了一个另外的 token，那么也不需要再附着这一个 token.</li><li>header 的 key 通常是 Authorization，如果你的不是这个，可以修改。</li></ul><p>如果你需要在遇到诸如 401 Not Authorised 的时候进行刷新 token，可以使用 Authenticator，这是一个专门设计用于当验证出现错误的时候，进行询问获取处理的拦截器：</p><div class="highlighter-rouge"><pre class="highlight"><code><span class="n">Authenticator</span> <span class="n">mAuthenticator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Authenticator</span><span class="o">()</span> <span class="o">{</span>
    <span class="nd">@Override</span> <span class="kd">public</span> <span class="n">Request</span> <span class="n">authenticate</span><span class="o">(</span><span class="n">Route</span> <span class="n">route</span><span class="o">,</span> <span class="n">Response</span> <span class="n">response</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">Your</span><span class="o">.</span><span class="na">sToken</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="na">refreshToken</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="na">request</span><span class="o">().</span><span class="na">newBuilder</span><span class="o">()</span>
                       <span class="o">.</span><span class="na">addHeader</span><span class="o">(</span><span class="s">"Authorization"</span><span class="o">,</span> <span class="n">Your</span><span class="o">.</span><span class="na">sToken</span><span class="o">)</span>
                       <span class="o">.</span><span class="na">build</span><span class="o">();</span>        
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p><strong>然后，对于以上的两个拦截器，分别使用 OkHttpClient.Builder 对象的 addNetworkInterceptor(mTokenInterceptor) 和 authenticator(mAuthenticator) 即可。</strong></p><h4>Retrofit：</h4><p>对于 Retrofit，我的配置是：</p><div class="highlighter-rouge"><pre class="highlight"><code><span class="n">Retrofit</span> <span class="n">retrofit</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Retrofit</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">baseUrl</span><span class="o">(</span><span class="n">AppConfig</span><span class="o">.</span><span class="na">BASE_URL</span><span class="o">)</span>
        <span class="o">.</span><span class="na">client</span><span class="o">(</span><span class="n">client</span><span class="o">)</span>
        <span class="o">.</span><span class="na">addCallAdapterFactory</span><span class="o">(</span><span class="n">RxJavaCallAdapterFactory</span><span class="o">.</span><span class="na">create</span><span class="o">())</span>
        <span class="o">.</span><span class="na">addConverterFactory</span><span class="o">(</span><span class="n">GsonConverterFactory</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">gson</span><span class="o">))</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="n">service</span> <span class="o">=</span> <span class="n">retrofit</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">YourApi</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</code></pre></div><p>解释：</p><ul><li>baseUrl: 原来的 setEndPoint 方法变成了 baseUrl</li><li>client 即上面的 OkHttp3 对象</li><li>addCallAdapterFactory 增加 RxJava 适配器</li><li>addConverterFactory 增加 Gson 转换器</li></ul><p>参考资料：</p><ul><li><a href="https://realm.io/news/droidcon-jake-wharton-simple-http-retrofit-2/" target="_blank">Simple HTTP with Retrofit 2</a></li></ul></article></main></body></html>